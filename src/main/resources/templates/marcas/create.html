<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{layout::head}">
    <meta charset="UTF-8">
    <title>Registrar Marca de Vehículo</title>
    <style>
        .stock-input-container {
          display: flex;
          align-items: center;
          gap: 5px;
        }
        .stock-btn {
          width: 40px;
          height: 40px;
          font-size: 18px;
          text-align: center;
          cursor: pointer;
        }
    </style>
</head>
<body>
<nav th:insert="~{layout::menu}"></nav>
<br />
<div class="card">
    <div class="card-header text-bg-secondary">
        Mantenimiento de Marcas
    </div>
    <div class="card-body">
        <h5 class="card-title">Registrar Nueva Marca</h5>
        <hr />

        <form th:action="@{/marcas/save}" method="post" th:object="${marca}" id="formMarca" onsubmit="return validarFormulario()">
            <!-- Campo Nombre -->
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="txtNombreMarca"
                       th:field="*{nombreMarca}"
                       placeholder="Ejemplo: Toyota, Honda" required>
                <label for="txtNombreMarca">Nombre de la Marca</label>
                <div class="text-danger small" id="errorNombre"></div>
            </div>

            <!-- Campo Stock con botones + y - -->
            <div class="mb-3">
                <label for="txtStock" class="form-label">Stock Disponible</label>
                <div class="stock-input-container">
                    <button type="button" class="btn btn-outline-secondary stock-btn" onclick="cambiarStock(-1)">-</button>
                    <input type="number" class="form-control" id="txtStock" th:field="*{stock}"
                           placeholder="Cantidad en stock" min="0" required>
                    <button type="button" class="btn btn-outline-secondary stock-btn" onclick="cambiarStock(1)">+</button>
                </div>
                <div class="text-danger small" id="errorStock"></div>
            </div>

            <!-- Botones de acción -->
            <button type="submit" class="btn btn-success shadow-sm">
                <i class="bi bi-save2-fill me-1"></i> Registrar marca
            </button>
            <a href="/marcas" class="btn btn-secondary shadow-sm">
                <i class="bi bi-arrow-left me-1"></i> Cancelar
            </a>
        </form>
    </div>
</div>

<!-- Script de validación y control de stock -->
<script>
    const marcasRegistradas = ["Toyota", "Chevrolet", "Ford"];

    function calcularSimilitud(str1, str2) {
        str1 = str1.toLowerCase();
        str2 = str2.toLowerCase();
        const m = str1.length, n = str2.length;
        const dp = Array.from({length: m+1}, () => Array(n+1).fill(0));

        for (let i = 0; i <= m; i++) dp[i][0] = i;
        for (let j = 0; j <= n; j++) dp[0][j] = j;

        for (let i = 1; i <= m; i++) {
            for (let j = 1; j <= n; j++) {
                if (str1[i-1] === str2[j-1]) {
                    dp[i][j] = dp[i-1][j-1];
                } else {
                    dp[i][j] = 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
                }
            }
        }
        const distancia = dp[m][n];
        const maxLen = Math.max(m, n);
        return (1 - distancia / maxLen);
    }

    function cambiarStock(valor) {
        const stockInput = document.getElementById("txtStock");
        let stock = parseInt(stockInput.value) || 0;
        stock += valor;
        if (stock < 0) stock = 0;
        stockInput.value = stock;
    }

    function validarFormulario() {
        const nombre = document.getElementById("txtNombreMarca").value.trim();
        const errorNombre = document.getElementById("errorNombre");
        let valido = true;

        errorNombre.textContent = "";

        // Validación solo de letras
        if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(nombre)) {
            errorNombre.textContent = "⚠️ El nombre de la marca solo puede contener letras.";
            valido = false;
        }

        // Verificar duplicados o similitudes
        for (let marca of marcasRegistradas) {
            if (marca.toLowerCase() === nombre.toLowerCase()) {
                errorNombre.textContent = "⚠️ Esta marca ya está registrada.";
                valido = false;
                break;
            }
            if (calcularSimilitud(marca, nombre) >= 0.6) {
                errorNombre.textContent = "⚠️ El nombre es demasiado parecido a una marca ya registrada.";
                valido = false;
                break;
            }
        }

        return valido; // si es válido se envía al servidor
    }

    // Validación dinámica mientras escribe
    document.getElementById("txtNombreMarca").addEventListener("input", function () {
        const errorNombre = document.getElementById("errorNombre");
        const nombre = this.value.trim();
        errorNombre.textContent = "";

        if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]*$/.test(nombre)) {
            errorNombre.textContent = "⚠️ El nombre de la marca solo puede contener letras.";
            return;
        }
        for (let marca of marcasRegistradas) {
            if (marca.toLowerCase() === nombre.toLowerCase()) {
                errorNombre.textContent = "⚠️ Esta marca ya está registrada.";
                return;
            }
            if (calcularSimilitud(marca, nombre) >= 0.6) {
                errorNombre.textContent = "⚠️ El nombre es demasiado parecido a una marca ya registrada.";
                return;
            }
        }
    });
</script>

</body>
</html>



